<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Médico</title>
    <style>
        body {
            margin: 20px;
            font-family: Arial, sans-serif;
        }
        /* Container principal: grid com 3 colunas */
        .dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        /* Cada coluna organiza seus itens em duas linhas */
        .column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        /* Cartões de listas e gráficos */
        .list-card, .chart-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .list-card {
            max-height: 359px;
            overflow-y: auto;
        }
        .chart-container {
            text-align: center;
            min-height: 350px;
        }
        h2 {
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #2c3e50;
        }
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        li {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9em;
        }
        li:hover {
            background: #e9ecef;
        }
        .stats-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            font-size: 0.9em;
        }
        img {
            height: auto;
            max-height: 316px;
            object-fit: contain;
        }
        .loader {
            font-style: italic;
            color: #666;
        }
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Coluna Esquerda: Condições -->
        <div class="column">
            <!-- Lista de Condições -->
            <div class="list-card">
                <h2>Top 10 Condições Médicas</h2>
                <ul id="conditions-list">
                    {% for item in conditions %}
                    <li data-type="condition" data-value="{{ item.condition_text }}">
                        {{ item.condition_text }} ({{ item.count }})
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <!-- Gráfico de Barras para Condições -->
            <div class="chart-container">
                <img src="{{ url_for('plot_conditions') }}" alt="Gráfico de Barras - Condições">
            </div>
        </div>
                <!-- Coluna Direita: Medicamentos -->
                <div class="column">
                    <!-- Lista de Medicamentos -->
                    <div class="list-card">
                        <h2>Top 10 Medicamentos</h2>
                        <ul id="medications-list">
                            {% for item in medications %}
                            <li data-type="medication" data-value="{{ item.medication_text }}">
                                {{ item.medication_text }} ({{ item.count }})
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <!-- Gráfico de Barras para Medicamentos -->
                    <div class="chart-container">
                        <img src="{{ url_for('plot_medications') }}" alt="Gráfico de Barras - Medicamentos">
                    </div>
                </div>

        <!-- Coluna Central: Gráfico de Pizza + Estatísticas -->
        <div class="column">
            <!-- Gráfico de Pizza Interativo -->
            <div class="chart-container" id="pieChart">
                <h3 id="pieTitle">Selecione um item da lista condição ou medicamento</h3>
                <!-- O gráfico de pizza será injetado aqui -->
            </div>
                    <!-- Estatísticas de Pacientes -->
        <div class="list-card">
            <div class="column">
                <h2>Estatísticas de Pacientes</h2>
                <div class="stats-item">Masculino: {{ male_count }}</div>
                <div class="stats-item">Feminino: {{ female_count }}</div>
                <div class="stats-item">Outros: {{ other_gender_count }}</div>
            </div>
        </div>
        </div>
    </div>

    <!-- Script para atualizar o gráfico de pizza sem recarregar a página -->
    <script>
document.addEventListener('DOMContentLoaded', function() {
    function handleItemClick(event) {
        event.preventDefault();
        event.stopPropagation();
        const li = event.target.closest('li');
        if (li) {
            const type = li.getAttribute('data-type');  
            const value = li.getAttribute('data-value');
            updatePieChart(type, value);
        }
    }

    // Capturar cliques nas listas de condições e medicamentos
    document.getElementById('conditions-list').addEventListener('click', handleItemClick);
    document.getElementById('medications-list').addEventListener('click', handleItemClick);

    // Capturar clique no gráfico de barras (Top 10 Condições Médicas)
    document.getElementById('barChartConditions').addEventListener('click', function() {
        updatePieChart('condition', 'Top 10 Condições Médicas');
    });

    function updatePieChart(type, value) {
        const pieContainer = document.getElementById('pieChart');
        pieContainer.innerHTML = "";

        const pieTitle = document.createElement('h3');
        pieTitle.id = 'pieTitle';
        pieTitle.textContent = `${type === 'condition' ? 'Condição' : 'Medicamento'} ${value}`;
        pieContainer.appendChild(pieTitle);

        const loader = document.createElement('div');
        loader.className = 'loader';
        loader.textContent = 'Carregando gráfico...';
        pieContainer.appendChild(loader);

        const timestamp = new Date().getTime();
        const encodedValue = encodeURIComponent(value);
        const imgSrc = `/plot/pie/${type}/${encodedValue}?t=${timestamp}`;

        const img = document.createElement('img');
        img.src = imgSrc;
        img.alt = 'Distribuição por Gênero';
        img.style.maxHeight = '300px';
        img.style.display = 'none';

        img.addEventListener('load', function() {
            loader.remove();
            img.style.display = 'block';
        });

        img.addEventListener('error', function() {
            loader.remove();
            pieTitle.textContent = 'Erro ao carregar o gráfico';
        });

        pieContainer.appendChild(img);
    }
});

    </script>
</body>
</html>
